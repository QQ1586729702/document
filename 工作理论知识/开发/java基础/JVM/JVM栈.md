### 1. 概述：

**Java 虚拟机栈(Java Virtual Machine Stacks)，早期也叫 Java 栈**。==每个线程在创建的时候都会创建一个虚拟机栈==，其内部保存一个个的栈帧(Stack Frame），对应着一次次 Java 方法调用，是线程私有的，生命周期和线程一致。

### 2. 特点：

- 栈是一种快速有效的分配存储方式，访问速度仅次于程序计数器
- JVM 直接对虚拟机栈的操作只有两个：每个方法执行，伴随着入栈（进栈/压栈），方法执行结束出栈
- 栈不存在垃圾回收问题

### 3. 栈的存储单位：

- 每个线程都有自己的栈，栈中的数据都是以**栈帧**（Stack Frame）的格式存在
- **在这个线程上正在执行的每个方法都各自有对应的一个栈帧**
- 栈帧是一个内存区块，是一个数据集，维系着方法执行过程中的各种数据信息

### 4. 栈运行原理：

- JVM 直接对 Java 栈的操作只有**两个**，对栈帧的**压栈和出栈**，遵循==“先进后出/后进先出”==原则
- 在**一条活动线程**中，**一个时间点上**，只会有**一个活动**的栈帧。即只有当前正在执行的方法的栈帧（栈顶栈帧）是有效的，这个栈帧被称为**当前栈帧**（Current Frame），与当前栈帧对应的方法就是当前方法（Current Method），定义这个方法的类就是当前类（Current Class）
- 执行引擎运行的所有字节码指令只针对当前栈帧进行操作
- 如果在该方法中调用了其他方法，对应的新的栈帧会被创建出来，放在栈的顶端，称为新的当前栈帧
- ==不同线程中所包含的栈帧是不允许存在相互引用的==，即不可能在一个栈帧中引用另外一个线程的栈帧
- 如果当前方法调用了其他方法，方法返回之际，当前栈帧会传回此方法的执行结果给前一个栈帧，接着，虚拟机会丢弃当前栈帧，使得前一个栈帧重新成为当前栈帧
- Java 方法有两种返回函数的方式，一种是正常的函数返回，使用`return`指令，另一种是**抛出异常**，不管用哪种方式，都会导致栈帧被弹出

### 5.栈帧的内部结构：

![[clipboard (9).png]]
**每个栈帧（Stack Frame）中存储着：**

- **局部变量表**（Local Variables）：当前方法储存的一些变量，基本储存单位是槽（solt）。32位的变量占一个槽，64位占两个槽

byte、short、char 在存储前被转换为int，boolean也被转换为int，0 表示 false，非 0 表示 true

long 和 double 则占据两个 Slot

- **操作数栈**（Operand Stack）(或称为表达式栈)：操作数栈，主要用于保存计算过程的中间结果，同时作为计算过程中变量临时的存储空间，在方法有返回值时，也保存返回值

- **动态链接**（Dynamic Linking）：指向运行时常量池的方法引用

- **方法返回地址**（Return Address）：方法正常退出或异常退出的地址

- **一些附加信息**：栈帧中还允许携带与 Java 虚拟机实现相关的一些附加信息。例如，对程序调试提供支持的信息，但这些信息取决于具体的虚拟机实现。


#java #jvm 